{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ game.title }} | Joystick Juice</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" href="{% static 'css/global/theme.css' %}">

    <link rel="stylesheet" href="{% static 'css/global/base.css' %}">

    <link rel="stylesheet" href="{% static 'css/game/detail.css' %}">
</head>

<body class="bg-dark text-white">

<main class="main-content flex-grow-1">

    <div class="game-container">

        <div class="hero-banner">
            {% if game.banner_url %}
            <div class="banner-img">
                <div class="banner-overlay banner-bg-style"
                     style="background-image: url('{{ game.banner_url }}');">
                </div>
            </div>
            {% endif %}

            <div class="hero-content page-container d-flex flex-column flex-lg-row align-items-center">

                <div class="cover-box panel mb-4 mb-lg-0">
                    {% if game.cover_url %}
                    <img src="{{ game.cover_url }}" alt="{{ game.title }} Cover" class="img-fluid rounded img-cover-detail">
                    {% endif %}
                </div>

                <div class="meta-box ps-lg-4 text-center text-lg-start">
                    <h1 class="game-title display-3 theme-accent">{{ game.title }}</h1>
                    <div class="submeta text-muted mb-3">
                        <span class="badge text-bg-secondary">{{ game.genre }}</span>
                        <span class="mx-1">•</span>
                        <span class="badge text-bg-secondary">{{ game.release_date }}</span>
                        <span class="mx-1">•</span>
                        <span class="badge text-bg-secondary">{{ game.developer|default:"Desconhecido" }}</span>
                    </div>
                    <p class="descricao text-light">{{ game.synopsis }}</p>
                </div>
            </div>
        </div>

        <div class="content-layout row page-container mt-4 g-4">

            {% if user.is_authenticated %}
            <div class="col-lg-4">
                <div class="actions-box panel p-3">
                    <div class="actions-header border-bottom border-secondary-subtle pb-2 mb-3">
                        <h3 class="text-white h5"><i class="fas fa-bolt me-2 theme-accent"></i> SUA ATIVIDADE</h3>
                    </div>

                    <div class="action-buttons d-grid gap-2 mb-4">

                        <form action="{% url 'toggle_favorite' game.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn action-btn w-100 py-2
                                {% if is_favorite %}btn-danger{% else %}btn-custom-outline{% endif %}">
                                <i class="fa-solid fa-heart me-2"></i>
                                <span>{% if is_favorite %}Remover dos Favoritos{% else %}Adicionar aos Favoritos{% endif %}</span>
                            </button>
                        </form>

                        <form action="{% url 'toggle_like' game.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn action-btn w-100 py-2
                                {% if is_liked %}btn-success{% else %}btn-custom-outline{% endif %}">
                                <i class="fa-solid fa-thumbs-up me-2"></i>
                                <span>{% if is_liked %}Remover Curtida{% else %}Curtir Jogo{% endif %}</span>
                            </button>
                        </form>

                        {% if request.user.is_authenticated and review_exists %}
                            <button class="btn action-btn w-100 py-2 btn-info-subtle text-info-emphasis"
                                onclick="window.location.href='{% url 'detail_review' user_review.pk %}'">
                                <i class="fa-solid fa-eye me-2"></i>
                                <span>Ver Sua Review</span>
                            </button>
                        {% else %}
                            <button class="btn action-btn w-100 py-2 btn-info"
                                onclick="window.location.href='{% url 'create_review' game.pk %}'">
                                <i class="fa-solid fa-star me-2"></i>
                                <span>Fazer Review</span>
                            </button>
                        {% endif %}

                        <button class="btn action-btn w-100 py-2 btn-custom-light"
                                onclick="window.location.href='{% url 'list_reviews' game.pk %}'">
                            <i class="fa-solid fa-list-ul me-2"></i>
                            <span>Todas as Reviews</span>
                        </button>
                    </div>

                    {% if in_list %}
                        <div class="status-section border-top border-secondary-subtle pt-3">
                            <p class="status-current mb-2 text-muted">
                                Status atual:
                                <strong class="text-white">
                                    {% if user_status == "P" %}Para jogar
                                    {% elif user_status == "C" %}Concluído
                                    {% elif user_status == "J" %}Jogando
                                    {% elif user_status == "A" %}Abandonado
                                    {% else %}---
                                    {% endif %}
                                </strong>
                            </p>

                            <form action="{% url 'update_game_status' game.id %}" method="post" class="d-flex flex-column gap-2">
                                {% csrf_token %}

                                <select name="status" class="form-select bg-deep text-white form-select-lg">
                                    {% for code, label in status_form.fields.status.choices %}
                                        <option value="{{ code }}" {% if code == user_status %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>

                                <button class="btn btn-custom-accent py-2 mt-2" type="submit">
                                    <i class="fas fa-check me-2"></i> Salvar Status
                                </button>
                            </form>

                            <div class="remove-section mt-3">
                                <form action="{% url 'remove_from_list' game.id %}" method="post">
                                    {% csrf_token %}
                                    <button class="btn btn-sm btn-outline-danger w-100" type="submit">
                                        <i class="fa-solid fa-trash me-1"></i> Remover da Minha Lista
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% else %}
                        <form action="{% url 'add_to_list' game.id %}" method="post">
                            {% csrf_token %}
                            <button class="btn btn-custom-accent w-100 py-2" type="submit">
                                <i class="fa-solid fa-plus me-2"></i> Adicionar à Minha Lista
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="col-lg-{% if user.is_authenticated %}8{% else %}12{% endif %}">
                {% if game.trailer_url %}
                <div class="trailer-container panel p-3">
                    <h3 class="text-white h5 mb-3"><i class="fas fa-video me-2 theme-accent"></i> Trailer Oficial</h3>
                    <div class="ratio ratio-16x9 shadow-lg rounded">
                        <iframe
                            src="{{ game.trailer_url }}"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen
                            referrerpolicy="strict-origin-when-cross-origin"
                            title="Trailer do jogo"
                            class="rounded">
                        </iframe>
                    </div>
                </div>
                {% endif %}

                <div class="panel p-4 mt-4">
                    <h3 class="text-white h5 mb-3"><i class="fas fa-chart-line me-2 theme-accent"></i> Estatísticas Globais</h3>
                    <p class="text-muted">Detalhes de popularidade e notas médias (a ser implementado).</p>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/game/detail.js' %}"></script>

</body>
</html>